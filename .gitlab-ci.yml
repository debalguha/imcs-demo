image: docker:latest

before_script:
- docker login -u dineshpillai -p Pill2017
- export KUBECONFIG=/etc/kubernetes/admin.conf

stages:
 - build
 - test
 - deletenamespace
 - createnamespace
 - deploy


build:
 stage: build 
 script:
    - mvn -version
    - mvn clean package install -DskipTests
    - cd streamprocessor
    - mvn docker:build	
    - docker push dineshpillai/innovation-mu-streamers

deleteNameSpace:
  stage: deletenamespace
  script:
   - kubectl delete namespace mu-architecture-demo
  allow_failure: true

createNameSpace:
  stage: createnamespace
  script: 
   - kubectl create namespace mu-architecture-demo
  allow_failure: true
  dependencies:
    - deletenamespace

deploy:
  stage: deploy
  script:
    - cd kubernetes	
    - kubectl apply -f run-mzk.yaml
  dependencies:
    - build 
